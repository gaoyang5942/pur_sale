<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>到店自取服务</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="__STATIC__/wechat/css/index.css" />
		<link rel="stylesheet" type="text/css" href="__STATIC__/wechat/css/nav.css" />
		<link rel="stylesheet" type="text/css" href="__STATIC__/wechat/css/dizhiguanli.css" />
		<link rel="stylesheet" type="text/css" href="__STATIC__/wechat/css/wodingdan.css" />
	</head>

	<body>
		<div class="container">
			<div class="container_Div">
			
			<form action="" method="post" class="tianjia_form">
				<ul class="tianjia_formLi">
					<li class="tianjia_formLi_li">
						<span>取药人 :</span>
						<input type="text" name="" id="address_name" value="" placeholder="请填写取药人姓名(必填)" />
					</li>
					<li class="tianjia_formLi_li">
						<span>联系电话 :</span>
						<input type="text" name="" id="address_tel" value="" placeholder="请填写联系电话(必填)" />
					</li>
					<li class="tianjia_formLi_li">
						<span>取药店铺 :</span>
						<input type="text" name="" id="pharmacy_name" value="" readonly />
					</li>
					<li class="tianjia_formLi_li"> 
						<span>取药地址 :</span>
						<input type="text" name="" id="pharmacy_address" value="" readonly />
					</li>
					<img src="__STATIC__/wechat/img/huawei_img.png" alt="" />

				</ul>

			</form>
			<div class="zhifuxuanze">
						<ul class="zhifu_ul">
							<li class="dingdxq_mian_div_li songyao_li">
								<div class="xuanzhe_div" id="bot1">
									<span><i style="color: red;">*</i> 支付选择</span>
									<span class="xuanzhe_div_span songhuo_span">
										<span class="xuan_span1" pay_type="1">线上支付<img src="__STATIC__/wechat/img/shouhuo_img.png"/></span>
									</span>

								</div>
								<div class="xuanzhe_divShow zezaoceng_pop" id="tab_quyao1">
									<h3>支付选择</h3>
									<ul class="xuanzhe_divShow_ul1 show_ul">
										<li pay_type="1">线上支付</li>
										<li pay_type="2">货到付款</li>
									</ul>
									<p class="guanbi">关 闭</p>
								</div>
							</li>
						</ul>
						
					</div>
					<div class="zezaoceng" id="zezaoceng1"></div>
			<div class="ywcheng daodianziqu">

			</div>
			<div class="dingdxq_mian_div">
				<ul class="dingdxq_mian_div_ul">
					<li>
						<span class="dingdxq_mian_div_span">商品总价 : </span>
						<span class="dingdxq_mian_div_span2" id="sub_total"></span>
					</li>
					<li>
						<span class="dingdxq_mian_div_span">优惠金额 : </span>
						<span class="dingdxq_mian_div_span2" id="discount"></span>
					</li>
					<li>
						<span class="dingdxq_mian_div_span">医保支付 : </span>
						<span class="dingdxq_mian_div_span2" id="medical_pay"></span>
					</li>
					<li>
						<span class="dingdxq_mian_div_span">自费支付 : </span>
						<span class="dingdxq_mian_div_span2" id="self_pay"></span>
					</li>
					<li>
						<span class="dingdxq_mian_div_span">配送费 : </span>
						<span class="dingdxq_mian_div_span2" id="shipping"></span>
					</li>
					<li>
						<span class="dingdxq_mian_div_span">本次积分 : </span>
						<span class="dingdxq_mian_div_span2" id="integral"></span>
					</li>
					
					<li>
						<span class="dingdxq_mian_div_span">订单总价 : </span>
						<span class="dingdxq_mian_div_span3" id="total">￥<span class="total"></span></span>
					</li>
					<li>
						<form action="" method="post" class="dingdxq_mian_div_ul_form">
							<span style="float: left;">备注</span>
							<textarea style="border:0;margin-left: 0.5rem;padding: 0.2rem;" id="orgAuditDesc" name="orgAuditDesc" rows="2" cols="" placeholder="请填写30字内"></textarea>
							<p style="display: inline-block;"><span id="text-count">30</span>/30</p>
						</form>
					</li>
					<li class="dingdxq_mian_div_ul_num">
						<span>共计<b class="drug_num"></b>件商品</span>
						<span>合计 : <span class="daodian_num">￥<span class="total"></span></span></span>
					</li>
				</ul>
			</div>
			<div class="clear"></div>
	
			</div>
		</div>
		<!--错误提示-->
		<div class="cuowu iframe" style="display: none">
			<p class="p1">无法操作</p>
			<p class="p"><img src="__STATIC__/wechat/img/cuowu_tishi.png" style="width: 15%;"/></p>
			<p class="p2"></p>
			<p class="p3"><a href="javascript:void(0)" onclick="location.href = sessionStorage.getItem('last_page')">知道了</a></p>
		</div>
		<div class="cuowuTs" id="cuowuTs" style="display: none"></div>
		<!--错误提示 end-->
		<footer class="daifahuo_footer">
			<div class="foot_daifuK">
				<span class="foot_daifuK_zj">总计 : </span>
				<span class="foot_daifuK_num"><small>￥</small><span class="total"></span></span>
				<a href="javascript:void(0)" onclick="create_order()" id="pay_order" style="pointer-events:none">去结算(<span class="drug_num"></span>)</a>
			</div>
		</footer>

	</body>
	<script src="__STATIC__/wechat/js/jquery-2.1.4.min.js"></script>
	<script src="__STATIC__/wechat/js/base.js"></script>
	<script type="text/javascript">
		var param = get_url_param();
		var cart_ids = param.cart_ids ? param.cart_ids : 0;
		$(document).ready(function(){
			$.post("/api/wechat/get_user_info",function(data){
                var data = JSON.parse(data);
                if(data.code == '202'){
                    window.location.href = '/api/wechat/oauth';
                }
                else if(data.code == '200')
                {
                	get_order_info();
                }
            });
		});

		$('.show_ul li').each(function(){ //点击添加class 移除class
			$(this).click(function(){
				$(this).addClass("active_show");
				$(this).siblings().removeClass("active_show");
			});
		})
		$('.guanbi').click(function() {
			$("#tab_quyao").hide();
			$("#zezaoceng").hide();
			$("#tab_quyao1").hide();
			$("#zezaoceng1").hide();
		})
		$(function() {
			$("#tab_quyao1").hide()
			$("#zezaoceng1").hide()
		})
		$("#bot1").click(function() {
			$("#tab_quyao1").toggle();
			$("#zezaoceng1").toggle();
		})
		$("#zezaoceng1").click(function() {
			$("#tab_quyao1").hide()
			$("#zezaoceng1").hide()
		})
		/*字数限制*/
    $("#orgAuditDesc").on("input propertychange", function () {
        var $this = $(this),
                _val = $this.val(),
                count = "";
        if (_val.length > 30) {
            $this.val(_val.substring(0, 30));
        }
        count = 30 - $this.val().length;
        $("#text-count").text(count);
    });

		$('.dizhi_guanli .dizhi_guanli_formA1').each(function() {
			$(this).click(function() {
				$(this).parent().parent().parent().remove('.dizhi_guanli');
			})
		})
		$('.xuanzhe_divShow_ul1 li').each(function(){
			$(this).click(function(){
				var time_text=$(this).text();
				var pay_type = $(this).attr('pay_type');
				$(".xuan_span1").addClass("time_img").text(time_text);
				$(".xuan_span1").attr('pay_type', pay_type);
			})
		})

	function create_order()
	{
		var data = {};
		data.address_name = $('#address_name').val();
		data.address_tel = $('#address_tel').val();
		data.order_type = 2;
		data.cart_ids = cart_ids;
		// data.address_id = address_id;
		data.drugorder_payment_method = $('.xuan_span1').attr('pay_type');
		// data.arrive_time = $('.xuan_span').attr('shipping_time');
		data.remark = $('#orgAuditDesc').val();

		$.ajax({
			type: 'post',
			url: '/api/order/store',
			data: data,
			dataType: 'json',
			success: function(response){
				var type = $('.xuan_span1').attr('pay_type');
				if(response.error == 0)
				{
					if (type == 1) {
						location.href = '/wechat/weins/weinspay?order_no=' + response.data.order_id;
					}else if (type == 2) {
						location.href = '/wechat/order/all';
					}
				}
				else
				{
					$('.cuowu.iframe').show();
					$('.p2').text('创建订单失败！');
				}
			},
			error: function(error){
				console.log(error);
				$('.cuowu.iframe').show();
				$('.p2').text('创建订单失败！');
			}
		});
	}

	function get_order_info()
	{
		$.ajax({
			type: 'post',
			url: '/api/order/create',
			data: {order_type: 2, cart_ids: cart_ids},
			success: function(response){
				console.log(response);
				if(response.error == 0)
				{
					var response_data = response.data;
					var drug_info = '';

					$('#pharmacy_name').val(response_data.pharmacy.pharmacy_name);
					$('#pharmacy_address').val(response_data.pharmacy.pharmacy_address);

					for(var drug of response_data.cart_drug)
					{
						drug_info += '<div class="ywcheng_mian">';
						drug_info += '<div class="ywcheng_mian_sp">';
						drug_info += '<ul class="dingdxq_mian_sp_ul1">';
						drug_info += '<li class="daifahuo_mian_ulImg" style="margin-left: 1rem;">';
						if(drug.drug.drugdetail.drug_detailed_img)
						{
							drug_info += '<img src="__UPLOAD__/'+drug.drug.drugdetail.drug_detailed_img+'" />';
						}
						else
						{
							drug_info += '<img src="__STATIC__/wechat/img/none.jpg"';
						}
						drug_info += '</li>';
						drug_info += '<li class="ywcheng_mian_ulText">';
						drug_info += '<p class="ywcheng_mian_p1">'+drug.drug.drug_store_name+'</p>';
						drug_info += '<p class="gybgg">'+drug.drug.drugdetail.drug_detailed_specifications+'</p>';
						drug_info += '<p class="ywcheng_mian_p">';
						drug_info += '<span class="ywcheng_mian_num1">￥'+drug.drug.drugdetail.drug_detailed_present_price/100+'</span>';
						drug_info += '<span class="sancu_span"><del>￥'+drug.drug.drugdetail.drug_detailed_original_price/100+'</del></span>';
						drug_info += '<span class="ywcheng_mian_num">x'+drug.cart_drug_num+'</span>';
						drug_info += '</p>';
						drug_info += '</li>';
						drug_info += '</ul>';
						drug_info += '</div>';
						drug_info += '</div>';
					}
					$('.ywcheng.daodianziqu').append(drug_info);

					var price = response_data.total;
					$('#sub_total').text('￥' + (price.sub_total/100).toFixed(2));
					$('#discount').text('￥' + (price.discount/100).toFixed(2));
					$('#medical_pay').text('￥' + (price.medical_pay/100).toFixed(2));
					$('#self_pay').text('￥' + (price.self_pay/100).toFixed(2));
					$('#shipping').text('￥' + (price.shipping/100).toFixed(2));
					$('#integral').text(Math.floor(price.total));
					$('.total').text((price.total/100).toFixed(2));

					$('.drug_num').text(response_data.cart_drug.length);

					$('#pay_order').css('pointer-events', 'auto');
				}
				else
				{
					$('.cuowu.iframe').show();
					$('.cuowuTs').show();
					$('.p2').text(response.msg);
				}
			},
			error: function(error){
				console.log(error);
				$('.cuowu.iframe').show();
				$('.cuowuTs').show();
				$('.p2').text('获取订单信息失败！');
			}
			// data: {order_type: param.order_type, cart_ids: param.cart_ids, address_id: param.address_id},
		});
	}
	</script>

</html>